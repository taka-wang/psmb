# drone.io:0.5

pipeline:

    test-psmb-tcp: # glide ready
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true -f tcp/Dockerfile .

    test-redis-writer: # glide ready
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /var/tmp:/var/tmp # for test
        commands:
            - docker-compose -f redis-writer/docker-compose.yml rm -f -a
            - docker-compose -f redis-writer/docker-compose.yml pull
            - docker-compose -f redis-writer/docker-compose.yml build --no-cache
            - docker-compose -f redis-writer/docker-compose.yml up --abort-on-container-exit
            - docker-compose -f redis-writer/docker-compose.yml stop
            - docker-compose -f redis-writer/docker-compose.yml rm -f -a
            - cat /var/tmp/success      # test
            - rm -f /var/tmp/success    # cleanup

    test-mgo-history: # glide ready
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /var/tmp:/var/tmp # for test
        commands:
            - docker-compose -f mgo-history/docker-compose.yml rm -f -a
            - docker-compose -f mgo-history/docker-compose.yml pull
            - docker-compose -f mgo-history/docker-compose.yml build --no-cache
            - docker-compose -f mgo-history/docker-compose.yml up --abort-on-container-exit
            - docker-compose -f mgo-history/docker-compose.yml stop
            - docker-compose -f mgo-history/docker-compose.yml rm -f -a
            - cat /var/tmp/success      # test
            - rm -f /var/tmp/success    # cleanup

    test-redis-history: # glide ready
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /var/tmp:/var/tmp # for test
        commands:
            - docker-compose -f redis-history/docker-compose.yml rm -f -a
            - docker-compose -f redis-history/docker-compose.yml pull
            - docker-compose -f redis-history/docker-compose.yml build --no-cache
            - docker-compose -f redis-history/docker-compose.yml up --abort-on-container-exit
            - docker-compose -f redis-history/docker-compose.yml stop
            - docker-compose -f redis-history/docker-compose.yml rm -f -a
            - cat /var/tmp/success      # test
            - rm -f /var/tmp/success    # cleanup


    test-mem-filter: # glide ready
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true -f mem-filter/Dockerfile .

    test-mem-reader: # glide ready
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true -f mem-reader/Dockerfile .

    test-redis-filter: # glide ready
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /var/tmp:/var/tmp # for test
        commands:
            - docker-compose -f redis-filter/docker-compose.yml rm -f -a
            - docker-compose -f redis-filter/docker-compose.yml pull
            - docker-compose -f redis-filter/docker-compose.yml build --no-cache
            - docker-compose -f redis-filter/docker-compose.yml up --abort-on-container-exit
            - docker-compose -f redis-filter/docker-compose.yml stop
            - docker-compose -f redis-filter/docker-compose.yml rm -f -a
            - cat /var/tmp/success      # test
            - rm -f /var/tmp/success    # cleanup

    test-viper-conf: # glide ready
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true -f viper-conf/Dockerfile .

    test-mini-conf: # glide ready
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true -f mini-conf/Dockerfile .

    test-psmbtcp-srv: # glide ready
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true -f tcp-srv/Dockerfile .

    ci:  # glide ready
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /var/tmp:/var/tmp # for test
        commands:
            - docker-compose rm -f -a
            - docker-compose pull
            - docker-compose build --no-cache
            - docker-compose up --abort-on-container-exit
            - docker-compose stop
            - docker-compose rm -f -a
            - cat /var/tmp/success      # test
            - rm -f /var/tmp/success    # cleanup





    test-mem-reader:
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true mem-writer/.

    test-psmb:
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true .

    test-cron:
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true cron/.
