# drone.io:0.5

pipeline:

    test-redis-history: # redis-based history data store
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker-compose -f redis-history/docker-compose.yml rm -f -a
            - docker-compose -f redis-history/docker-compose.yml pull
            - docker-compose -f redis-history/docker-compose.yml build
            - docker-compose -f redis-history/docker-compose.yml up --abort-on-container-exit
            - docker-compose -f redis-history/docker-compose.yml stop
            - docker-compose -f redis-history/docker-compose.yml rm -f -a

    test-redis-writer: # redis-based writer data store
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker-compose -f redis-writer/docker-compose.yml rm -f -a
            - docker-compose -f redis-writer/docker-compose.yml pull
            - docker-compose -f redis-writer/docker-compose.yml build
            - docker-compose -f redis-writer/docker-compose.yml up --abort-on-container-exit
            - docker-compose -f redis-writer/docker-compose.yml stop
            - docker-compose -f redis-writer/docker-compose.yml rm -f -a

    test-cron: # scheduler
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true cron/.

    test-mreader: # in-memory reader data store
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true mem-reader/.

    test-mwriter: # in-memory writer data store
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true mem-writer/.

    test-psmb: # psmb lib
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true .

    test-psmb-tcp: # psmb/tcp lib
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker build --no-cache=true tcp/.

    ci:
        image: takawang/dind
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        commands:
            - docker-compose rm -f -a
            - docker-compose pull
            - docker-compose build
            - docker-compose up --abort-on-container-exit
            - docker-compose stop
            - docker-compose rm -f -a