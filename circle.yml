
machine:
    services:
        - docker

dependencies:
    pre:
        - sudo pip install docker-compose
    override:
        # './...' is a relative pattern which means all subdirectories
        - go get -t -d -v ./...
        - go build -v

test:
    pre:
        # test psmb and do codecov
        - mkdir shared
        # psmb
        - docker build -t psmb --no-cache=true . 
        - docker run -v "$PWD/shared:/shared" psmb
        # viper-conf
        - docker build -t conf --no-cache=true -f viper-conf/Dockerfile .
        - docker run -v "$PWD/shared:/shared" conf
        # codecov
        - bash <(curl -s https://codecov.io/bash) -t 558aa53d-c58d-4df4-a1c1-a22a6e6d8572
        # ci
        - docker-compose rm -f -a
        - docker-compose pull
        - docker-compose build
    override:
        - docker-compose up --abort-on-container-exit
    post:
        - docker-compose stop
        - docker-compose rm -f -a